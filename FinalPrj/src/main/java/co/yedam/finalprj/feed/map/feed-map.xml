<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="co.yedam.finalprj.feed.map.FeedMap">

	<!-- 일반회원 글만, 탈퇴한 회원, 정지당한 회원 글 보이지 않음 , 블락한 회원의 글 제외 -->
	<select id="feedSelectList"
		parameterType="co.yedam.finalprj.feed.vo.FeedVO" resultType="map">
		SELECT *
	    FROM (SELECT
	    				<![CDATA[CASE WHEN #{user_id} <> U.USER_ID THEN TRUNC(CAL(#{user_id} ,U.USER_ID),0)
	    				ELSE 0 END ]]>,
						u.USER_ID 	"user_id",
						u.EMAIL 	"email",
						u.NAME 		"name",
						u.PHOTO 	"photo",
						u.STATUS 	"status",
						u.LAT 		"lat",
						u.LON 		"lon",
						u.TIMEZONE 	"time_zone",
						f.FEED_ID 	"feed_id",
						f.CONTENT 	"content",
						f.PHOTO 	"fphoto",
						f.REG_DATE 	"reg_date",
						f.TAGS 		"tags",
						f.WRITE_LAN "write_lan",
						d.ORIGINAL_NAME, 
	      				d.UUID 		"uuid",
	        			d.DIRECTORY,
	        			p.DELETE_YN "delete_yn",
	        			nvl(likeCnt.LIKECNT,0) "like_cnt",
	        			F_COMMENT_CNT(f.feed_id) "cmt"
			  FROM 		feed f JOIN users u
						ON f.USER_ID = u.USER_ID
	        			left outer join photo p
	        			on  f.PHOTO = p.PHOTO_ID
	        			left outer join photo_detail d
	       				on p.PHOTO_ID=  d.PHOTO_ID
	       				left outer join feedLikeCnt_v likeCnt
                		on f.FEED_ID = likeCnt.FEED_ID
			  WHERE  	u.STATUS = '일반회원'
			  AND NOT   f.USER_ID IN (  SELECT BLOCKED
							        	FROM block
								    	WHERE USER_ID = #{user_id}
								      )
			<if test="tags != null">
			AND tags like '%' || #{tags} || '%'
	  	    </if>
	  	    <if test="write_lan != null">
			AND write_lan = #{write_lan}
	  	    </if>
	  	    <if test="location != null">
			AND 1 BETWEEN 0 AND 2000
	  	    </if>
			ORDER BY f.REG_DATE DESC)
	</select>

	<!--오늘 생일인 친구 조회 , 블릭한 친구 제외-->
	<select id="birthUser"
		parameterType="co.yedam.finalprj.users.vo.UsersVO" resultType="co.yedam.finalprj.friends.vo.FriendsVO">
		SELECT 
			   f.FOLLOWING , 
			   TO_CHAR(sysdate,'YYYY') - TO_CHAR(u.BIRTH,'YYYY') as "age"
		FROM   friends f , users u
		WHERE  f.FOLLOWING = u.USER_ID
		AND    TO_CHAR(u.BIRTH,'MM/DD') = TO_CHAR(sysdate,'MM/DD')
		AND    f.user_id = #{user_id}
		AND    u.STATUS = '일반회원'
		AND    not f.FOLLOWING in ( SELECT BLOCKED
								    FROM block
								    WHERE USER_ID = #{user_id}
								 )
	</select>
	
	<!-- 나와 상대방의 일치하는 관심사 수 , 블락친구 제외, 이미 친구인 유저 제외 -->
	<select id="sameTopicList" parameterType="co.yedam.finalprj.users.vo.UsersVO" resultType="co.yedam.finalprj.users.vo.UsersVO">
		SELECT 
				topic_cnt(#{topic},topic) as "count" , 
				user_id
		FROM users
		WHERE not user_id IN (#{user_id})
		AND NOT user_id IN (  SELECT blocked
		                      FROM block
		                      WHERE user_id = #{user_id}
		                    )
		AND NOT user_id IN ( SELECT FOLLOWING
		                     FROM friends
		                     WHERE user_id = #{user_id}
		                    )
		AND STATUS = '일반회원'
	</select>
	



	
	<!-- 피드 등록 -->
	<insert id="feedInsert" statementType="CALLABLE" parameterType="co.yedam.finalprj.feed.vo.FeedVO">
		{ CALL fphoto_insert( #{user_id}, #{content}, #{original_name}, #{tags}, #{uuid}, #{file_size}, #{directory}, #{write_lan} )} 
	</insert>
	
	<!-- 피드 삭제 -->
	<delete id="feedDelete" statementType="CALLABLE" parameterType="co.yedam.finalprj.feed.vo.FeedVO">
		{ CALL feed_delete( #{feed_id})} 
	</delete>
	
	<!-- 피드 수정 -->
	<update id="feedUpdate" statementType="CALLABLE" parameterType="co.yedam.finalprj.feed.vo.FeedVO">
		{ CALL feed_update( #{feed_id}, #{content}, #{photo} ,#{tags}, #{original_name}, #{uuid}, #{file_size}, #{directory}, #{write_lan} )} 
	</update>
	
	
	<!-- 친구 맵  -->
	<select id="allUser" parameterType="co.yedam.finalprj.users.vo.UsersVO" resultType="co.yedam.finalprj.users.vo.UsersVO">
		select  u.email,
		        u.name,
		        u.birth,
		        u.gender,
		        u.topic,
		        u.LANGUAGE1,
				u.LANGUAGE2,
				u.COUNTRY,
				u.REG_DATE,
				u.PROFILE,
				u.USER_ID,
				u.STATUS,
				u.FLAG,
        		NVL( fv.feedCnt,0) "feedCnt",
		        NVL(fing.FOLLOWINGCNT,0) "followingCnt",
		        NVL(fer.FOLLOWERCNT,0) "followerCnt"
		from 	users u LEFT OUTER JOIN feedCnt_v fv
				on u.USER_ID =fv.USER_ID
		   		LEFT OUTER JOIN followingCnt_v fing
		    	on u.user_id = fing.USER_ID
		    	LEFT OUTER JOIN followerCnt_v fer
		    	on u.USER_ID = fer.FOLLOWING
		where
				STATUS = '일반회원'
				AND NOT   u.user_id IN (#{user_id})
				AND NOT   u.USER_ID IN (  SELECT BLOCKED
							              FROM block
								    	  WHERE USER_ID = #{user_id}
				                    )
				AND  NOT  u.USER_ID IN (  SELECT following
							        	  FROM friends
								    	  WHERE USER_ID = #{user_id}
				                      	) 
	</select>
	<select id="newUser" parameterType="co.yedam.finalprj.users.vo.UsersVO" resultType="co.yedam.finalprj.users.vo.UsersVO">
	   select   u.email,
		        u.name,
		        u.birth,
		        u.gender,
		        u.topic,
		        u.LANGUAGE1,
				u.LANGUAGE2,
				u.COUNTRY,
				u.REG_DATE,
				u.PROFILE,
				u.USER_ID,
				u.STATUS,
				u.FLAG,
        		NVL( fv.feedCnt,0) "feedCnt",
		        NVL(fing.FOLLOWINGCNT,0) "followingCnt",
		        NVL(fer.FOLLOWERCNT,0) "followerCnt"
		from 	users u LEFT OUTER JOIN feedCnt_v fv
				on u.USER_ID =fv.USER_ID
		   		LEFT OUTER JOIN followingCnt_v fing
		    	on u.user_id = fing.USER_ID
		    	LEFT OUTER JOIN followerCnt_v fer
		    	on u.USER_ID = fer.FOLLOWING
		where
				STATUS = '일반회원'
				AND NOT u.user_id IN (#{user_id})
				AND NOT u.USER_ID IN (   SELECT BLOCKED
							             FROM block
								    	 WHERE USER_ID = #{user_id}
				                    )
				AND NOT u.USER_ID IN (   SELECT following
							        	 FROM friends
								    	 WHERE USER_ID = #{user_id}
				                      	)         
				AND  u.REG_DATE BETWEEN TRUNC(SYSDATE , 'iw') AND TRUNC(SYSDATE, 'iw')+6          
	</select>
       
	<!-- 나이, 성별, 국가, 언어, 관심사 -->
  	<select id="searchFriend" parameterType="co.yedam.finalprj.users.vo.UsersVO" resultType="co.yedam.finalprj.users.vo.UsersVO">
		SELECT  u.email,
				u.name,
				u.birth,
				u.gender,
				u.topic,
				u.LANGUAGE1,
				u.LANGUAGE2,
				u.COUNTRY,
				u.REG_DATE,
				u.PROFILE,
				u.USER_ID,
				u.STATUS,
				u.FLAG,
				a.age,
        		NVL( fv.feedCnt,0) "feedCnt",
		        NVL(fing.FOLLOWINGCNT,0) "followingCnt",
		        NVL(fer.FOLLOWERCNT,0) "followerCnt"
		FROM 	users u join age_v a
				on u.USER_ID = a.USER_ID
			    LEFT OUTER JOIN feedCnt_v fv
				on u.USER_ID =fv.USER_ID
			    LEFT OUTER JOIN followingCnt_v fing
			    on u.user_id = fing.USER_ID
			    LEFT OUTER JOIN followerCnt_v fer
			    on u.USER_ID = fer.FOLLOWING
		WHERE	u.status = '일반회원'
				AND NOT u.user_id IN ('user1')
			    AND NOT u.USER_ID IN (  SELECT BLOCKED
			                            FROM block
			                            WHERE USER_ID = #{user_id}
					                 )
				AND NOT u.USER_ID IN (  SELECT following
			                            FROM friends
			                            WHERE USER_ID = #{user_id}
					                  ); 
		<if test="s_age != null">
			AND a.age between #{s_age} and #{e_age} 
		</if>
		<if test="s_dage != null">
			AND a.age NOT between #{s_dage} and #{e_dage} 
		</if>
 		<if test="gender != null">
			AND u.gender = #{gender}
		</if>
		<if test="country != null">
			AND upper(u.COUNTRY) = upper(#{country})
		</if>
		
		<if test="dcountry != null">
			AND NOT upper(u.COUNTRY) IN (upper(#{dcountry}))
		</if>
		<if test="language1 != null">
			AND  u.language1 = #{language1}
		</if>
  		<if test="dtopic != null">
			AND not REGEXP_LIKE (u.topic,#{dtopic})
		</if>
		 <if test="topic != null">
			AND REGEXP_LIKE (u.topic,#{topic})
		</if> 
	</select>  
	
	
	<!-- 관리자 -->
	<select id="oneSelectFeed" parameterType="co.yedam.finalprj.feed.vo.FeedVO" resultType="co.yedam.finalprj.feed.vo.FeedVO">
		select *
		from feed
		where feed_id = #{feed_id}
	</select>             
</mapper>