<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="co.yedam.finalprj.letter.map.LetterMap">
	<!-- 전체 편지 -->
	<select id="selectAllLetter" resultType="co.yedam.finalprj.letter.vo.LetterVO">
		SELECT * FROM LETTER
		 WHERE ARRIVE_DATE IS NOT NULL
		   AND TO_ID =#{to_id}
		   AND GUBUN IN ('일반','교정')
		 ORDER BY ARRIVE_DATE DESC
	</select>

	<!-- 나에게 편지를 보낸 친구목록 -->
	<select id="selectAllFriend" parameterType="co.yedam.finalprj.letter.vo.LetterVO" resultType="co.yedam.finalprj.letter.vo.LetterVO">
		SELECT  L.USER_ID, U.NAME, L.SEND_DATE, L.ARRIVE_DATE FROM LETTER L, USERS U
		 WHERE L.USER_ID=U.USER_ID
    	   AND L.TO_ID =#{to_id}
    	   AND L.USER_ID IN (SELECT DISTINCT USER_ID FROM LETTER WHERE USER_ID NOT IN #{to_id})
		 ORDER BY ARRIVE_DATE DESC
	</select>
	
	<!-- 답장 안한 편지목록 -->
	<select id="selectNewLetter" parameterType="co.yedam.finalprj.letter.vo.LetterVO" resultType="co.yedam.finalprj.letter.vo.LetterVO">
		SELECT L.*, U.NAME FROM LETTER L, USERS U
		 WHERE L.USER_ID=U.USER_ID
    	   AND SEND_YN ='N'
		   AND TO_ID =#{to_id}
		   AND ARRIVE_DATE IS NOT NULL
		 ORDER BY ARRIVE_DATE DESC
	</select>
	
	<!-- 해당친구이름과 해당편지목록 -->
	<select id="selectFriendLetter" parameterType="co.yedam.finalprj.letter.vo.LetterVO" resultType="co.yedam.finalprj.letter.vo.LetterVO">
 		SELECT * FROM LETTER_FROM_V
		 WHERE TO_ID =#{to_id} AND USER_ID =#{user_id}
		    OR TO_ID =#{user_id} AND USER_ID =#{to_id}
		 ORDER BY ARRIVE_DATE DESC
	</select>
	
	<!-- 임시저장한 편지조회 -->
	<select id="selectSaveLetter" parameterType="co.yedam.finalprj.letter.vo.LetterVO" resultType="co.yedam.finalprj.letter.vo.LetterVO">
		SELECT L.*, U.NAME FROM LETTER L, USERS U
		 WHERE L.USER_ID=U.USER_ID
		   AND L.USER_ID =#{user_id}
		   AND GUBUN ='임시저장'
		 ORDER BY SEND_DATE DESC
	</select>
	
	<!-- 편지 작성 -->
	<insert id="insertLetter" parameterType="co.yedam.finalprj.letter.vo.LetterVO">
		INSERT INTO LETTER
			(LETTER_ID, TO_ID, USER_ID, CONTENT, PHOTO, GUBUN)
		VALUES
			('letter_'||letter_seq.nextval, #{to_id}, #{user_id}, #{content}, #{photo}, #{gubun})			
	</insert>

	<!-- 편지교정 작성 -->
	<insert id="insertLetterC" parameterType="co.yedam.finalprj.letter.vo.LetterVO">
		INSERT INTO LETTERC
			(LETTER_ID, LINE, ORIGIN, CORRECTING)
		VALUES
			(#{letter_id}, #{line}, #{origin}, #{correcting})		
	</insert>
	
	<!-- 편지 삭제 -->
	<update id="deleteLetter" parameterType="co.yedam.finalprj.letter.vo.LetterVO">
		UPDATE LETTER SET TO_DELETE = 'Y' 
		 WHERE LETTER_ID =#{letter_id}
		   AND USER_ID =#{user_id}
	</update>

</mapper>