<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="co.yedam.finalprj.letter.map.LetterMap">
	<!-- 나에게 편지를 보낸 친구목록 -->
	<select id="selectAllFriend" parameterType="co.yedam.finalprj.letter.vo.LetterVO" resultType="co.yedam.finalprj.letter.vo.LetterVO">
		SELECT F.USER_ID, U.NAME FROM (SELECT DISTINCT USER_ID
								         FROM LETTER
								        WHERE TO_ID = #{to_id}) F, USERS U
		 WHERE F.USER_ID = U.USER_ID
	     ORDER BY NAME
	</select>
	
	<!-- 답장 안한 편지목록 -->
	<select id="selectNewLetter" parameterType="co.yedam.finalprj.letter.vo.LetterVO" resultType="co.yedam.finalprj.letter.vo.LetterVO">
		SELECT L.*, U.NAME FROM LETTER L, USERS U
		 WHERE L.USER_ID=U.USER_ID
    	   AND SEND_YN ='N'
    	   AND TO_DELETE='N'
		   AND TO_ID =#{to_id}
		   AND ARRIVE_DATE IS NOT NULL
		 ORDER BY ARRIVE_DATE DESC
	</select>
	
	<!-- 받는이(TO_ID)가 답장해야할 차례 / 해당하는 유저아이디 한건 조회 -->
	<select id="replyLetter" parameterType="co.yedam.finalprj.letterc.vo.LettercVO" resultType="co.yedam.finalprj.letterc.vo.LettercVO">
	SELECT DISTINCT FIRST_VALUE(TO_ID) OVER(ORDER BY SEND_DATE DESC) AS USER_ID
	  FROM (SELECT * FROM LETTER_FROM_V
		     WHERE TO_ID =#{to_id} AND USER_ID =#{user_id} 
		        OR TO_ID =#{user_id} AND USER_ID =#{to_id}
		  ORDER BY ARRIVE_DATE DESC)
	</select>
	
	<!-- 해당친구이름과 해당편지목록 -->
	<select id="selectFriendLetter" parameterType="co.yedam.finalprj.letter.vo.LetterVO" resultType="co.yedam.finalprj.letter.vo.LetterVO">
 		SELECT * FROM LETTER_FROM_V
		 WHERE TO_ID =#{to_id} AND USER_ID =#{user_id} AND TO_DELETE='N'
		    OR TO_ID =#{user_id} AND USER_ID =#{to_id} AND FROM_DELETE='N'
		 ORDER BY ARRIVE_DATE DESC
	</select>
	
	<!-- 임시저장한 편지조회 -->
	<select id="selectSaveLetter" parameterType="co.yedam.finalprj.letter.vo.LetterVO" resultType="co.yedam.finalprj.letter.vo.LetterVO">
		SELECT L.*, U.NAME FROM LETTER L, USERS U
		 WHERE L.USER_ID=U.USER_ID
		   AND L.USER_ID =#{user_id}
		   AND GUBUN ='임시저장'
		 ORDER BY SEND_DATE DESC
	</select>
	
	<!-- 편지 작성 -->
	<!-- 거리KM만큼 걸리는 시간+send_date = arrive_date 조건문 추가 필요-->
	<insert id="insertLetter" parameterType="co.yedam.finalprj.letter.vo.LetterVO">
		<selectKey keyProperty="distance" resultType="int" order="BEFORE">
			SELECT TRUNC(CAL(#{to_id}, #{user_id}),0) FROM DUAL
		</selectKey>
		
		INSERT INTO LETTER
			(LETTER_ID, TO_ID, USER_ID, CONTENT, PHOTO, GUBUN, ARRIVE_DATE)
		VALUES
			('letter_'||letter_seq.nextval, #{to_id}, #{user_id}, #{content}, #{photo, jdbcType=VARCHAR},#{gubun}
		<choose>
		<when test="distance lt 300">
			, SYSDATE+(INTERVAL '1' HOUR))
		</when>
		<when test="distance lt 2000">
			, SYSDATE+(INTERVAL '4' HOUR))
		</when>
		<when test="distance lt 4000">
			, SYSDATE+(INTERVAL '8' HOUR))
		</when>
		<when test="distance lt 6000">
			, SYSDATE+(INTERVAL '12' HOUR))
		</when>
		<when test="distance lt 8000">
			, SYSDATE+(INTERVAL '16' HOUR))
		</when>
		<when test="distance lt 10000">
			, SYSDATE+(INTERVAL '20' HOUR))
		</when>
		<when test="distance gte 10000">
			, SYSDATE+(INTERVAL '1' DAY))
		</when>
		</choose>
	</insert>
	
	<!-- 편지 삭제 -->
	<!-- 내가 작성자라면 FROM_DELETE / 작성자가 아니라면 TO_DATE -->	
	<update id="deleteLetter" parameterType="co.yedam.finalprj.letter.vo.LetterVO">
		<selectKey keyProperty="uid" resultType="String" order="BEFORE">
			SELECT USER_ID FROM LETTER
			 WHERE LETTER_ID =#{letter_id} 
		</selectKey>
		<choose>
		<when test='user_id == uid'>
		UPDATE LETTER SET FROM_DELETE = 'Y' 
		 WHERE LETTER_ID =#{letter_id}
		   AND USER_ID =#{user_id}
		</when>
		<otherwise>
		UPDATE LETTER SET TO_DELETE = 'Y' 
		 WHERE LETTER_ID =#{letter_id}
		   AND TO_ID =#{user_id}
		</otherwise>
		</choose>
	</update>

</mapper>